/*=============================================================================
	Author:			Eric M. Barnard - @ericmbarnard								
 Modified:   Sergiy Stotskiy - @stalniy                    
	License:		MIT (http://opensource.org/licenses/mit-license.php)		
																				
	Description:	Validation Library for KnockoutJS							
===============================================================================
*/
!function(a){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?a(require("knockout"),exports):"function"==typeof define&&define.amd?define(["knockout","exports"],a):a(ko,ko.validation={})}(function(a,b){if(void 0===typeof a)throw"Knockout is required, please ensure it is loaded before loading this validation plug-in";a.validation=b;var c=a.validation,d=a.utils,e=d.unwrapObservable,f=d.arrayForEach,g=d.extend,h=a.bindingHandlers,i={registerExtenders:!0,messagesOnModified:!0,errorsAsTitle:!0,errorsAsTitleOnModified:!1,messageTemplate:null,insertMessages:!0,parseInputAttributes:!1,writeInputAttributes:!1,decorateInputElement:!1,decorateElementOnModified:!0,errorClass:null,errorElementClass:"validationElement",errorMessageClass:"validationMessage",grouping:{deep:!1,observable:!0},validate:{}},j=g({},i);j.html5Attributes=["required","pattern","min","max","step"],j.html5InputTypes=["email","number","date"],j.reset=function(){g(j,i)},c.configuration=j,c.utils=function(){var b=(new Date).getTime(),g=d.domData,h="__ko_validation__",i={isArray:function(a){return a.isArray||"[object Array]"===Object.prototype.toString.call(a)},isObject:function(a){return null!==a&&"object"==typeof a},getValue:function(a){return"function"==typeof a?a():a},isValidatable:function(a){return a&&a.rules&&a.isValid&&a.isModified},insertAfter:function(a,b){a.parentNode.insertBefore(b,a.nextSibling)},newId:function(){return b+=1},getConfigOptions:function(a){var b,d=a;do b=i.contextFor(d,!0),d=d.parentNode;while(d&&!b);return b||c.configuration},setDomData:function(a,b){g.set(a,h,b)},getDomData:function(a){return g.get(a,h)},contextFor:function(a,b){switch(a.nodeType){case 1:case 8:var c=i.getDomData(a);if(c)return c;if(!b&&a.parentNode)return i.contextFor(a.parentNode)}return void 0},isEmptyVal:function(a){return void 0===a?!0:null===a?!0:""===a?!0:void 0},getOriginalElementTitle:function(a){var b=a.getAttribute("data-orig-title"),c=null!==b;return c?b:a.title},async:function(a){window.setImmediate?window.setImmediate(a):window.setTimeout(a,0)},forEach:function(a,b){if(i.isArray(a))return f(a,b);for(var c in a)a.hasOwnProperty(c)&&b(a[c],c)},observablesOf:function(b,c,d,f){var g=[];if(b.__kv_traversed===!0)return g;if(d.deep&&(d.flagged||(d.flagged=[]),b.__kv_traversed=!0,d.flagged.push(b)),"undefined"==typeof f&&(f=d.deep?1:-1),a.isObservable(b)&&c(b,g),0!==f){var h,j=e(b);h=j&&(i.isArray(j)||i.isObject(j))?j:[],i.forEach(h,function(a){a&&!a.nodeType&&g.push.apply(g,i.observablesOf(a,c,d,f+1))})}if(1===f&&d.deep){for(var k=d.flagged.length;k--;)delete d.flagged[k].__kv_traversed;d.flagged.length=0,delete d.flagged}return g}};return i}();var k=function(){function b(a){var b=[];return f(a,function(a){a.isValid()||b.push(a.error)}),b}function i(a,b){l.isValidatable(a)||a.extend({validatable:!0}),b.push(a)}var j=0,k=c.configuration,l=c.utils;return{init:function(a,b){j>0&&!b||(a=a||{},a.errorElementClass=a.errorElementClass||a.errorClass||k.errorElementClass,a.errorMessageClass=a.errorMessageClass||a.errorClass||k.errorMessageClass,g(k,a),k.registerExtenders&&c.registerExtenders(),j=1)},configure:function(a){c.init(a)},reset:c.configuration.reset,model:function(c,e){e=g(g({},k.grouping),e);var h,j,m=l.observablesOf(c,i,e),n=function(){return b(m)};return e.observable?(h=a.computed(n),h.throttleEvaluation=10,j=a.observable(0===h().length),h.subscribe(function(a){j(0===a.length)})):(h=n,j=function(){return 0===h().length}),n=null,g({isValid:j,errors:h,markAsModified:function(a){var b=0===arguments.length||a;f(m,function(a){a.isModified(b)})},isAnyInvalidModified:function(){return!!d.arrayFirst(m,function(a){return!a.isValid()&&a.isModified()})}},c)},formatMessage:function(a,b){return"function"==typeof a?a(b):a.replace(/\{0\}/gi,e(b))},addRule:function(a,b){return a.extend({validatable:!0}),a.rules.push(b),a},addAnonymousRule:function(a,b){void 0===b.message&&(b.message="Error"),c.addRule(a,b)},addExtender:function(b){a.extenders[b]=function(a,d){return d.message||d.onlyIf?c.addRule(a,{rule:b,message:d.message,params:l.isEmptyVal(d.params)?!0:d.params,condition:d.onlyIf}):c.addRule(a,{rule:b,params:d})}},registerExtenders:function(){if(k.registerExtenders)for(var b in c.rules)c.rules.hasOwnProperty(b)&&(a.extenders[b]||c.addExtender(b))},insertValidationMessage:function(a){var b=document.createElement("SPAN");return b.className=l.getConfigOptions(a).errorMessageClass,l.insertAfter(a,b),b},parseInputValidationAttributes:function(a,b){f(c.configuration.html5Attributes,function(d){var e=a.getAttribute(d);null!==e&&c.addRule(b(),{rule:d,params:e||!0})});var d=a.getAttribute("type");f(c.configuration.html5InputTypes,function(a){a===d&&c.addRule(b(),{rule:"date"===a?"dateISO":a,params:!0})})},writeInputValidationAttributes:function(a,b){var e=b();if(e&&e.rules){var g=e.rules();f(c.configuration.html5Attributes,function(b){var c,e=d.arrayFirst(g,function(a){return a.rule.toLowerCase()===b.toLowerCase()});e&&(c=e.params,"pattern"===e.rule&&e.params instanceof RegExp&&(c=e.params.source),a.setAttribute(b,c))}),g=null}},makeBindingHandlerValidatable:function(b){var c=a.bindingHandlers[b].init;a.bindingHandlers[b].init=function(a,b,d,e,f){return c(a,b,d,e,f),h.exposeValidationResult.init(a,b,d,e,f)}}}}();g(a.validation,k),c.rules={},c.rules.required={validator:function(a,b){var c,d=/^\s+|\s+$/g;return void 0===a||null===a?!b:(c=a,"string"==typeof a&&(c=a.replace(d,"")),b?(c+"").length>0:!0)},message:"This field is required."},c.rules.min={validator:function(a,b){return c.utils.isEmptyVal(a)||a>=b},message:"Please enter a value greater than or equal to {0}."},c.rules.max={validator:function(a,b){return c.utils.isEmptyVal(a)||b>=a},message:"Please enter a value less than or equal to {0}."},c.rules.minLength={validator:function(a,b){return c.utils.isEmptyVal(a)||a.length>=b},message:"Please enter at least {0} characters."},c.rules.maxLength={validator:function(a,b){return c.utils.isEmptyVal(a)||a.length<=b},message:"Please enter no more than {0} characters."},c.rules.pattern={validator:function(a,b){return c.utils.isEmptyVal(a)||null!==a.toString().match(b)},message:"Please check this value."},c.rules.step={validator:function(a,b){if(c.utils.isEmptyVal(a)||"any"===b)return!0;var d=100*a%(100*b);return Math.abs(d)<1e-5||Math.abs(1-d)<1e-5},message:"The value must increment by {0}"},c.rules.email={validator:function(a,b){return b?c.utils.isEmptyVal(a)||b&&/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i.test(a):!0},message:"Please enter a proper email address"},c.rules.date={validator:function(a,b){return b?c.utils.isEmptyVal(a)||b&&!/Invalid|NaN/.test(new Date(a)):!0},message:"Please enter a proper date"},c.rules.dateISO={validator:function(a,b){return b?c.utils.isEmptyVal(a)||b&&/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/.test(a):!0},message:"Please enter a proper date"},c.rules.number={validator:function(a,b){return b?c.utils.isEmptyVal(a)||b&&/^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/.test(a):!0},message:"Please enter a number"},c.rules.digit={validator:function(a,b){return b?c.utils.isEmptyVal(a)||b&&/^\d+$/.test(a):!0},message:"Please enter a digit"},c.rules.phoneUS={validator:function(a,b){return b?c.utils.isEmptyVal(a)?!0:"string"!=typeof a?!1:(a=a.replace(/\s+/g,""),b&&a.length>9&&a.match(/^(1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/)):!0},message:"Please specify a valid phone number"},c.rules.equal={validator:function(a,b){var d=b;return a===c.utils.getValue(d)},message:"Values must equal"},c.rules.notEqual={validator:function(a,b){var d=b;return a!==c.utils.getValue(d)},message:"Please choose another value."},c.rules.unique={validator:function(a,b){var f=c.utils.getValue(b.collection),g=c.utils.getValue(b.externalValue),h=0;return a&&f?(d.arrayFilter(e(f),function(c){a===(b.valueAccessor?b.valueAccessor(c):c)&&h++}),(void 0!==g&&a!==g?1:2)>h):!0},message:"Please make sure the value is unique."},function(){c.registerExtenders()}(),h.exposeValidationResult=function(){return{init:function(b,d){var e=c.utils.getConfigOptions(b),f=d();if(e.parseInputAttributes&&c.utils.async(function(){c.parseInputValidationAttributes(b,d)}),!c.utils.isValidatable(f))return!1;if(e.insertMessages){var g=c.insertValidationMessage(b);e.messageTemplate?a.renderTemplate(e.messageTemplate,{field:f},null,g,"replaceNode"):a.applyBindingsToNode(g,{validationMessage:f})}e.writeInputAttributes&&c.writeInputValidationAttributes(b,d),e.decorateInputElement&&a.applyBindingsToNode(b,{validationStyle:f})}}}(),c.makeBindingHandlerValidatable("value"),c.makeBindingHandlerValidatable("checked"),h.validationMessage={update:function(a,b){var e=b();if(!c.utils.isValidatable(e))throw new Error("Observable is not validatable");var f=c.utils.getConfigOptions(a),g=e.isModified(),h=e.error.isEmpty(),i=null,j=!1;(!f.messagesOnModified||g)&&(i=h?null:e.error(),j=!h),d.setTextContent(a,i);var k="none"!==a.style.display;k&&!j?a.style.display="none":!k&&j&&(a.style.display="")}},h.validationStyle={update:function(a,b){var d=b();if(!c.utils.isValidatable(d))throw new Error("Observable is not validatable");var e=c.utils.getConfigOptions(a),f=d.isModified(),g=d.error.isEmpty();h.css.update(a,function(){var a={};return a[e.errorElementClass]=!e.decorateElementOnModified||f?!g:!1,a}),e.errorsAsTitle&&h.validationStyle.setErrorAsTitleOn(a,d,e)},setErrorAsTitleOn:function(a,b,d){var e=b.error.isEmpty(),f=b.isModified();h.attr.update(a,function(){if(!d.errorsAsTitleOnModified||f){var g=c.utils.getOriginalElementTitle(a);return e?{title:g,"data-orig-title":null}:{title:b.error,"data-orig-title":g}}})}},h.validationOptions={init:function(a,b){var d=e(b());if(d){var f=g({},c.configuration);g(f,d),c.utils.setDomData(a,f)}}},function(){function b(){this.target.isModified(!0)}function d(){this(null)}function e(){return null===this()}function g(a){return 1===arguments.length?(this.__failedRule=a,this):this.__failedRule}function h(a,b,d){var e="undefined"==typeof d.params?!0:d.params;return b.validator(a(),e)?!0:(a.failedRule(d).error(c.formatMessage(d.message||b.message,d.params)),!1)}function i(a,b,d){a.isValidating(!0),b.validator(a(),d.params||!0,function(e){if(a.isValid()){var f,g=e;c.utils.isObject(e)&&(g=e.isValid,f=e.message||""),g||a.failedRule(d).error(c.formatMessage(f||d.message||b.message,d.params))}a.isValidating(!1)})}a.extenders.validation=function(a,b){return f(c.utils.isArray(b)?b:[b],function(b){c.addAnonymousRule(a,b)}),a},a.extenders.validatable=function(f,h){if(c.utils.isObject(h)||(h={enable:h}),"enable"in h||(h.enable=!0),h.enable&&!c.utils.isValidatable(f)){f.error=a.observable(null),f.error.clear=d,f.error.isEmpty=e,f.rules=a.observableArray(),f.failedRule=g,f.failedRule(null),f.isValidating=a.observable(!1),f.isModified=a.observable(!1),f.isValid=a.observable(!0),f.error.subscribe(function(){f.isValid(f.error.isEmpty())});var i=f.subscribe(b),j=a.computed(function(){f(),c.process(f)}),k=c.configuration.validate;j.throttleEvaluation=h.throttle||k&&k.throttle,f._disposeValidation=function(){this.rules.removeAll(),i.dispose(),j.dispose(),delete this.rules,delete this.error,delete this.isValid,delete this.isValidating,delete this.isModified}}else h.enable===!1&&f._disposeValidation&&f._disposeValidation();return f},c.process=function(a){for(var b,d,e=a.rules(),f=0,g=e.length;g>f;f++)if(d=e[f],!d.condition||d.condition())if(b=d.rule?c.rules[d.rule]:d,b.async||d.async)i(a,b,d);else if(!h(a,b,d))return!1;return a.failedRule(null).error.clear(),!0}}(),a.applyBindingsWithValidation=function(b,d,e){var f,g,h=arguments.length;h>2?(f=d,g=e):2>h?f=document.body:arguments[1].nodeType?f=d:g=arguments[1],c.init(),g&&c.utils.setDomData(f,g),a.applyBindings(b,d)},a.validatedObservable=function(b){return a.observable(b).extend({validatable:!0})}});