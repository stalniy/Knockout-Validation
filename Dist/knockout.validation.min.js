/*=============================================================================
	Author:			Eric M. Barnard - @ericmbarnard								
 Modified:   Sergiy Stotskiy - @stalniy                    
	License:		MIT (http://opensource.org/licenses/mit-license.php)		
																				
	Description:	Validation Library for KnockoutJS							
===============================================================================
*/
!function(a){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?a(require("knockout"),exports):"function"==typeof define&&define.amd?define(["knockout","exports"],a):a(ko,ko.validation={})}(function(a,b,c){if("undefined"==typeof a)throw"Knockout is required, please ensure it is loaded before loading this validation plug-in";a.validation=b;var d=a.validation,e=a.utils,f=e.unwrapObservable,g=e.arrayForEach,h=e.extend,i=a.bindingHandlers,j={registerExtenders:!0,messagesOnModified:!0,errorsAsTitle:!0,errorsAsTitleOnModified:!1,messageTemplate:null,insertMessages:!0,parseInputAttributes:!1,writeInputAttributes:!1,decorateInputElement:!1,decorateElementOnModified:!0,errorClass:null,errorElementClass:"validationElement",errorMessageClass:"validationMessage",grouping:{deep:!1,observable:!0},validate:{}},k=h({},j);k.html5Attributes=["required","pattern","min","max","step","minlength","maxlength"],k.html5InputTypes=["email","number","date"],k.reset=function(){h(k,j)},d.configuration=k,d.utils=function(){var b=(new Date).getTime(),h=e.domData,i="__ko_validation__",j={isArray:function(a){return a.isArray||"[object Array]"===Object.prototype.toString.call(a)},isObject:function(a){return null!==a&&"object"==typeof a},getValue:function(a){return"function"==typeof a?a():a},isValidatable:function(a){return a&&a.rules&&a.isValid&&a.isModified},insertAfter:function(a,b){a.parentNode.insertBefore(b,a.nextSibling)},newId:function(){return b+=1},getConfigOptions:function(a){var b,c=a;do b=j.contextFor(c,!0),c=c.parentNode;while(c&&!b);return b||d.configuration},setDomData:function(a,b){h.set(a,i,b)},getDomData:function(a){return h.get(a,i)},contextFor:function(a,b){switch(a.nodeType){case 1:case 8:var d=j.getDomData(a);if(d)return d;if(!b&&a.parentNode)return j.contextFor(a.parentNode)}return c},isEmptyVal:function(a){return a===c?!0:null===a?!0:""===a?!0:void 0},getOriginalElementTitle:function(a){var b=a.getAttribute("data-orig-title"),c=null!==b;return c?b:a.title},async:function(a){window.setImmediate?window.setImmediate(a):window.setTimeout(a,0)},forEach:function(a,b){if(j.isArray(a))return g(a,b);for(var c in a)a.hasOwnProperty(c)&&b(a[c],c)},observablesOf:function(b,c,d,e){var g=[];if(b.__kv_traversed===!0)return g;if(d.deep&&(d.flagged||(d.flagged=[]),b.__kv_traversed=!0,d.flagged.push(b)),"undefined"==typeof e&&(e=d.deep?1:-1),a.isObservable(b)&&c(b,g),0!==e){var h,i=f(b);h=i&&(j.isArray(i)||j.isObject(i))?i:[],j.forEach(h,function(a){a&&!a.nodeType&&g.push.apply(g,j.observablesOf(a,c,d,e+1))})}if(1===e&&d.deep){for(var k=d.flagged.length;k--;)delete d.flagged[k].__kv_traversed;d.flagged.length=0,delete d.flagged}return g},parseInputValidationAttributes:function(a,b){var c=d.configuration;g(c.html5Attributes,function(c){var e=a.getAttribute(c);null!==e&&(e&&!isNaN(+e)&&(e=Number(e)),d.addRule(b,{rule:c,params:e||0===e?e:!0}))});var f=a.type;-1!==e.arrayIndexOf(c.html5InputTypes,f)&&d.addRule(b,{rule:"date"===f?"dateISO":f,params:!0})},writeInputValidationAttributes:function(a,b){if(!j.isValidatable(b))return!1;var c=b.rules(),e={};g(c,function(a){e[a.rule.toLowerCase()]=a}),g(d.configuration.html5Attributes,function(b){var c=e[b.toLowerCase()];if(!c)return!0;var d=c.params;"pattern"===c.rule&&d instanceof RegExp&&(d=d.source),a.setAttribute(b,d)})}};return j}();var l=function(){var b=0,e=d.configuration,g=d.utils;return{init:function(a,c){b>0&&!c||(a=a||{},a.errorElementClass=a.errorElementClass||a.errorClass||e.errorElementClass,a.errorMessageClass=a.errorMessageClass||a.errorClass||e.errorMessageClass,h(e,a),e.registerExtenders&&d.registerExtenders(),b=1)},configure:function(a){d.init(a)},reset:d.configuration.reset,formatMessage:function(a,b){var c="undefined"!=typeof b.params?b.params:b;return"function"==typeof a?a(c):a.replace(/\{0\}/gi,f(c))},addRule:function(a,b){return a.extend({validatable:!0}),a.rules.push(b),a},addAnonymousRule:function(a,b){b.message===c&&(b.message="Error"),d.addRule(a,b)},addExtender:function(b){a.extenders[b]=function(a,c){return c.message||c.onlyIf?d.addRule(a,{rule:b,message:c.message,params:g.isEmptyVal(c.params)?!0:c.params,condition:c.onlyIf}):d.addRule(a,{rule:b,params:c})}},registerExtenders:function(){if(e.registerExtenders)for(var b in d.rules)d.rules.hasOwnProperty(b)&&(a.extenders[b]||d.addExtender(b))},insertValidationMessage:function(a){var b=document.createElement("SPAN");return b.className=g.getConfigOptions(a).errorMessageClass,g.insertAfter(a,b),b},makeBindingHandlerValidatable:function(b){var c=a.bindingHandlers[b].init;a.bindingHandlers[b].init=function(a,b,d,e,f){return c(a,b,d,e,f),i.exposeValidationResult.init(a,b,d,e,f)}}}}();h(a.validation,l),function(b){function c(a,b){this.each=f(g,a),this.find=f(e.arrayFirst,a),this.errors=this.errors.bind(this),d(this,b)}function d(b,c){if(c.observable){var d=a.computed(b.errors),e=a.observable(0===d().length);d.throttleEvaluation=10,d.subscribe(function(a){e(0===a.length)}),b.errors=d,b.isValid=e}}function f(a,b){return function(c,d){return d&&(c=c.bind(d)),a(b,c)}}function i(a){var b=[];return a.each(function(a){a.isValid()||b.push(a.error)}),b}function j(a,b){k.isValidatable(a)||a.extend({validatable:!0}),b.push(a)}var k=b.utils;c.prototype={markAsModified:function(a){var b=0===arguments.length||a;return this.each(function(a){a.isModified(b)}),this},isAnyInvalidModified:function(){return!!this.find(function(a){return!a.isValid()&&a.isModified()})},isModified:function(){return!!this.find(function(a){return a.isModified()})},isValid:function(){return 0===this.errors().length},errors:function(){return i(this)}},b.model=function(a,d){d=h(h({},b.configuration.grouping),d);var e=k.observablesOf(a,j,d);return h(new c(e,d),a)}}(a.validation),function(){var a={};a.required={validator:function(a,b){var d,e=/^\s+|\s+$/g;return a===c||null===a?!b:(d=a,"string"==typeof a&&(d=a.replace(e,"")),b?(d+"").length>0:!0)},message:"This field is required."},a.min={validator:function(a,b){return d.utils.isEmptyVal(a)||a>=b},message:"Please enter a value greater than or equal to {0}."},a.max={validator:function(a,b){return d.utils.isEmptyVal(a)||b>=a},message:"Please enter a value less than or equal to {0}."},a.minLength={validator:function(a,b){return d.utils.isEmptyVal(a)||a.length>=b},message:"Please enter at least {0} characters."},a.maxLength={validator:function(a,b){return d.utils.isEmptyVal(a)||a.length<=b},message:"Please enter no more than {0} characters."},a.pattern={validator:function(a,b){return d.utils.isEmptyVal(a)||null!==a.toString().match(b)},message:"Please check this value."},a.step={validator:function(a,b){if(d.utils.isEmptyVal(a)||"any"===b)return!0;var c=100*a%(100*b);return Math.abs(c)<1e-5||Math.abs(1-c)<1e-5},message:"The value must increment by {0}"},a.email={validator:function(a,b){return b?d.utils.isEmptyVal(a)||b&&/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i.test(a):!0},message:"Please enter a proper email address"},a.date={validator:function(a,b){return b?d.utils.isEmptyVal(a)||b&&!/Invalid|NaN/.test(new Date(a)):!0},message:"Please enter a proper date"},a.dateISO={validator:function(a,b){return b?d.utils.isEmptyVal(a)||b&&/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/.test(a):!0},message:"Please enter a proper date"},a.number={validator:function(a,b){return b?d.utils.isEmptyVal(a)||b&&/^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/.test(a):!0},message:"Please enter a number"},a.digit={validator:function(a,b){return b?d.utils.isEmptyVal(a)||b&&/^\d+$/.test(a):!0},message:"Please enter a digit"},a.phoneUS={validator:function(a,b){return b?d.utils.isEmptyVal(a)?!0:"string"!=typeof a?!1:(a=a.replace(/\s+/g,""),b&&a.length>9&&a.match(/^(1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/)):!0},message:"Please specify a valid phone number"},a.equal={validator:function(a,b){var c=b;return a===d.utils.getValue(c)},message:"Values must equal"},a.notEqual={validator:function(a,b){var c=b;return a!==d.utils.getValue(c)},message:"Please choose another value."},a.unique={validator:function(a,b){var g=d.utils.getValue(b.collection),h=d.utils.getValue(b.externalValue),i=0;return a&&g?(e.arrayFilter(f(g),function(c){a===(b.valueAccessor?b.valueAccessor(c):c)&&i++}),(h!==c&&a!==h?1:2)>i):!0},message:"Please make sure the value is unique."},a.minlength=a.minLength,a.maxlength=a.maxLength,d.rules=a,d.registerExtenders()}(),i.exposeValidationResult=function(){return{init:function(b,c){var e=d.utils.getConfigOptions(b),f=c();if(e.parseInputAttributes&&d.utils.async(function(){d.utils.parseInputValidationAttributes(b,f)}),!d.utils.isValidatable(f))return!1;if(e.insertMessages){var g=d.insertValidationMessage(b);e.messageTemplate?a.renderTemplate(e.messageTemplate,{field:f},null,g,"replaceNode"):a.applyBindingsToNode(g,{validationMessage:f})}e.writeInputAttributes&&d.utils.writeInputValidationAttributes(b,f),e.decorateInputElement&&a.applyBindingsToNode(b,{validationStyle:f})}}}(),d.makeBindingHandlerValidatable("value"),d.makeBindingHandlerValidatable("checked"),i.validationMessage={update:function(a,b){var c=b();if(!d.utils.isValidatable(c))throw new Error("Observable is not validatable");var e=d.utils.getConfigOptions(a),f=c.validationState(),g=null,h=!1;(!e.messagesOnModified||f.isModified)&&(g=f.isValid?null:f.error,h=!f.isValid),h&&i.text.update(a,function(){return g}),i.validationMessage.toggleErrorVisibility(a,h)},toggleErrorVisibility:function(a,b){var c="none"!==a.style.display;c&&!b?a.style.display="none":!c&&b&&(a.style.display="")}},i.validationStyle={update:function(a,b){var c=b();if(!d.utils.isValidatable(c))throw new Error("Observable is not validatable");var e=d.utils.getConfigOptions(a),f=c.validationState();i.css.update(a,function(){var a={};return a[e.errorElementClass]=!e.decorateElementOnModified||f.isModified?!f.isValid:!1,a}),e.errorsAsTitle&&i.validationStyle.setErrorAsTitleOn(a,c,e)},setErrorAsTitleOn:function(a,b,c){var e=b.validationState();i.attr.update(a,function(){var b=d.utils.getOriginalElementTitle(a),f=!c.errorsAsTitleOnModified||e.isModified;return f&&!e.isValid?{title:e.error,"data-orig-title":b}:!f||e.isValid?{title:b,"data-orig-title":null}:void 0})}},i.validationOptions={init:function(a,b){var c=f(b());if(c){var e=h({},d.configuration);h(e,c),d.utils.setDomData(a,e)}}},function(){function b(){this.target.isModified(!0)}function c(){this(null)}function e(){return null===this()}function f(a){return 1===arguments.length?(this.__failedRule=a,this):this.__failedRule}function h(){return{isModified:this.isModified(),isValid:this.isValid(),error:this.error()}}function i(a,b,c){var e="undefined"==typeof c.params?!0:c.params;return b.validator(a(),e)?!0:(a.failedRule(c).error(d.formatMessage(c.message||b.message,c)),!1)}function j(a,b,c){a.isValidating(!0),b.validator(a(),c.params||!0,function(e){if(a.isValid()){var f,g=e;d.utils.isObject(e)&&(g=e.isValid,f=e.message||""),g||a.failedRule(c).error(d.formatMessage(f||c.message||b.message,c))}a.isValidating(!1)})}a.extenders.validation=function(a,b){return g(d.utils.isArray(b)?b:[b],function(b){d.addAnonymousRule(a,b)}),a},a.extenders.validatable=function(g,i){if(d.utils.isObject(i)||(i={enable:i}),"enable"in i||(i.enable=!0),i.enable&&!d.utils.isValidatable(g)){g.error=a.observable(null),g.error.clear=c,g.error.isEmpty=e,g.rules=a.observableArray(),g.failedRule=f,g.failedRule(null),g.isValidating=a.observable(!1),g.isModified=a.observable(!1),g.isValid=a.observable(!0),g.error.subscribe(function(){g.isValid(g.error.isEmpty())});var j=g.subscribe(b),k=a.computed(function(){g(),d.process(g)}),l=d.configuration.validate,m=i.throttle||l&&l.throttle;g.validationState=a.computed({read:h,deferEvaluation:!0},g),g.validationState.throttleEvaluation=m?m+1:null,k.throttleEvaluation=m,g._disposeValidation=function(){this.rules.removeAll(),j.dispose(),k.dispose(),this.validationState.dispose(),delete this.rules,delete this.error,delete this.isValid,delete this.isValidating,delete this.isModified}}else i.enable===!1&&g._disposeValidation&&g._disposeValidation();return g},d.process=function(a){for(var b,c,e=a.rules(),f=0,g=e.length;g>f;f++)if(c=e[f],!c.condition||c.condition())if(b=c.rule?d.rules[c.rule]:c,b.async||c.async)j(a,b,c);else if(!i(a,b,c))return!1;return a.failedRule(null).error.clear(),!0}}(),a.applyBindingsWithValidation=function(b,c,e){var f,g,h=arguments.length;h>2?(f=c,g=e):2>h?f=document.body:arguments[1].nodeType?f=c:g=arguments[1],d.init(),g&&d.utils.setDomData(f,g),a.applyBindings(b,c)},a.validatedObservable=function(b){return a.observable(b).extend({validatable:!0})}});